{% extends "administrar/pestañas/base.html" %}
{% load partials %}

{% block contenido %}
  {% with titulo="Materias" descripcion="Gestiona las materias y los años en que se imparten" puede_añadir=perms.estudios.add_materia nombre_objeto="materia" %}
    {{ block.super }}
  {% endwith %}
{% endblock contenido %}

{% block parcial_objeto %}
  {% partial materia_objeto %}
{% endblock parcial_objeto %}

{% block campos %}
  {% partial campos %}
{% endblock campos %}

{% partialdef campos %}
  {# añadir nueva materia al agregarse correctamente #}
  {% if exito %}
    {% include "administrar/mensaje.html" with nombre_objeto="materia" %}
    {% with objeto=objeto_guardado reemplazar=1 %}
      {% partial materia_objeto %}
    {% endwith %}
  {% endif %}
  {% include "componentes/campo.html" with campo=form.nombre class="deshabilitar-subir elevado-2" %}

  {% with asignaciones=form.asignaciones %}
    <div
      role="group"
      aria-labelledby="asignaciones-materia-label"
      {% if asignaciones.errors %}
        aria-invalid="true" aria-errormessage="asignaciones-materia-error"
      {% endif %}
    >
      <p class="texto-sutil" id="asignaciones-materia-label">
        Años en los que se imparte:
      </p>

      <div class="asignaciones-materia">
        {% for opcion, label in asignaciones.field.choices %}
          {% with valor=opcion.value %}
            <input
              class="sr-only deshabilitar-subir"
              type="checkbox"
              name="{{ asignaciones.name }}"
              value="{{ valor }}"
              id="{{ asignaciones.name }}_{{ forloop.counter }}"
              {% if valor|stringformat:"i" in asignaciones.value %}checked{% endif %}
            />
            <label
              class="asignacion-materia"
              for="{{ asignaciones.name }}_{{ forloop.counter }}"
            >
              {{ label }}
            </label>
          {% endwith %}
        {% endfor %}
      </div>
      {% if asignaciones.errors %}
        <p
          id="asignaciones-materia-error"
          class="input-error"
          style="margin-top: .5rem;"
        >
          {{ asignaciones.errors.0 }}
        </p>
      {% endif %}
    </div>
  {% endwith %}
{% endpartialdef campos %}

{% partialdef materia_objeto %}
  {% comment %}<!-- prettier-ignore-start -->{% endcomment %}
    {# Para cuando se añada con el formulario, poder añadirlo a la lista de objetos se genera este div con hx-swap-oob (ya que por alguna razón, al generar el parcial, se elimina el primer elemento, lo que provocaría que no se añada el <li>, sino directamente el <article>) #}
    {% if reemplazar %}
      <div hx-swap-oob="afterend:.añadir-li">
    {% endif %}
  {% comment %}<!-- prettier-ignore-end -->{% endcomment %}

  <li>
    <article class="caja materia" {% if añadido %}data-nuevo{% endif %}>
      <header class="cabecera">
        <div class="titulo-contenedor">
          <h2 class="nombre">{{ objeto.nombre }}</h2>

          {% if añadido %}
            <span class="estado nuevo" role="status">Nueva</span>
          {% endif %}
        </div>
        <p class="fecha">
          <span class="decoracion-circular">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path stroke="none" d="M0 0h24v24H0z" fill="none" />
              <path
                d="M12.5 21h-6.5a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v5"
              />
              <path d="M16 3v4" />
              <path d="M8 3v4" />
              <path d="M4 11h16" />
              <path d="M16 19h6" />
              <path d="M19 16v6" />
            </svg>
          </span>
          Creada el {{ objeto.fecha_creacion|date:"D. d M. Y, h:i A" }}
        </p>
      </header>

      {% if objeto.asignaciones|length == 0 %}
        <p role="status" class="sin-asignaciones texto-sutil">
          {% include "componentes/iconos/alerta.html" %} No se ha asignado esta
          materia a ningún año.
        </p>
      {% else %}
        <ul class="asignaciones-materia">
          {% for año in lista_años %}
            <li>
              <span
                class="asignacion-materia"
                {% if año.numero in objeto.asignaciones %}
                  aria-label="sí"
                {% else %}
                  aria-label="no"
                {% endif %}
                role="status"
                {% if año.numero in objeto.asignaciones %}
                  data-asignada
                {% endif %}
              >
                {{ año.nombre_corto }}
              </span>
            </li>
          {% endfor %}
        </ul>
      {% endif %}
    </article>
  </li>

  {% comment %}<!-- prettier-ignore-start -->{% endcomment %}
    {% if reemplazar %}
      </div>
    {% endif %}
  {% comment %}<!-- prettier-ignore-end -->{% endcomment %}
{% endpartialdef materia_objeto %}
