{% extends "componentes/vista-lista/lista.html" %}
{% load utilidades %}
{% load grupos_variantes %}

{% block lista %}
  <ul
    x-bind="eventosLista"
    class="{{ 'grid grid-cols-[repeat(auto-fill,minmax(300px,1fr))] grid-cols-[repeat(auto-fill,minmax(140px,1fr))] supports-[not(grid-template-columns:repeat(auto-fill,minmax(140px,1fr)))]:(flex flex-wrap) gap-5'|expandir_variantes }}"
  >
    {% for tarea in lista_objetos %}
      <li>
        <article
          class="col ui-elevado rounded-xl overflow-hidden max-h-500px min-[600px]:max-h-250px"
        >
          <header
            class="flex jb items-start gap-x-3 rounded-t-xl border-b border-[--transparente-1] p-2 px-3 bg-fondo-700 "
          >
            <h2 class="font-bold line-clamp-4">
              {% include "componentes/tabla-adaptable/enlace-editar.html" with dato=tarea.nombre objeto=tarea %}
            </h2>
            {% with n=tarea.materias_asignadas|length %}
              <span
                class="text-sm rounded-full mt-0.5 p-0.5 px-4 bg-secundario dark:bg-secundario-600 text-secundario-texto text-xs font-semibold"
                role="status"
              >
                {{ n }}
                <span class="sr-only">asignaci{{ n|pluralize:'ón,ones' }}</span>
              </span>
            {% endwith %}
          </header>

          <div class="overflow-y-auto grid-row-[1/3] grid-col-[2/3]">
            <table
              class="size-full table-fixed [&_th,&_td]:tac [&_th:first-of-type,&_td:first-of-type]:text-left [&_th:last-of-type,&_td:last-of-type]:text-right [&_td:last-of-type]:justify-end"
              x-data="{
                ids: [{% for asignacion in tarea.materias_asignadas %}'{{ asignacion.id }}',{% endfor %}],

                alternarSeleccionTodo() {
                  if (this.ids.every((id) => this.filasSeleccionadas.has(id))) {
                    this.ids.forEach((id) => this.filasSeleccionadas.delete(id));
                  } else {
                    this.ids.forEach((id) => this.filasSeleccionadas.add(id));
                  }
                  
                  this.ultimaSeleccionadaIndice = null;
                }
              }"
            >
              <caption class="sr-only">
                Lista de materias asignadas
              </caption>

              <thead
                class="sticky top-0 bg-fondo-600 border-b border-[--transparente-1]"
              >
                {% with class="px-4 py-3 text-xs font-medium text-texto-sutil uppercase tracking-wider" %}
                  <tr>
                    <th class="{{ class }}">Materia</th>
                    <th class="{{ class }}">Sección</th>

                    {% if permisos.eliminar %}
                      <th class="{{ class }}">
                        <button
                          class="z-1"
                          type="checkbox"
                          autocomplete="off"
                          id="seleccionar-todos"
                          aria-label="Seleccionar todas las filas"
                          @click="alternarSeleccionTodo()"
                        >
                          {% include "componentes/iconos/edicion.html#seleccionar_todo" with class="size-5" %}
                        </button>
                      </th>
                    {% endif %}
                  </tr>
                {% endwith %}
              </thead>

              <tbody class="divide-y divide-[--transparente-1]">
                {% with class="px-4 py-2 whitespace-nowrap" %}
                  {% for asignacion in tarea.materias_asignadas %}
                    <tr>
                      <td class="{{ class }}">
                        {{ asignacion.profesormateria.materia.nombre }}
                      </td>

                      <td class="{{ class }}">
                        <span
                          class="rounded-full px-3 py-1 max-w-max bg-[--transparente-1] text-sm text-texto-sutil"
                        >
                          {{ asignacion.profesormateria.seccion.nombre }}
                        </span>
                      </td>

                      {% if permisos.eliminar %}
                        <td class="{{ class }}">
                          <div class="flex justify-end pr-0.5">
                            {%
                              with
                              indice=forloop.counter0|add:forloop.parentloop.counter0
                              id_l1=forloop.counter0|stringformat:"s"|add:'_'
                              id_l2=forloop.parentloop.counter0|stringformat:"s"
                              objeto=asignacion
                            %}
                              {% if not forloop.parentloop.first %}
                                {# empezar conteo desde uno a partir de la segunda iteración de profesores #}
                                {%
                                  include "componentes/vista-lista/objeto-check.html" with
                                  id_fila=id_l1|add:id_l2
                                  indice=forloop.counter|add:forloop.parentloop.counter0
                                %}
                              {% else %}
                                {%
                                  include "componentes/vista-lista/objeto-check.html" with
                                  id_fila=id_l1|add:id_l2
                                %}
                              {% endif %}
                            {% endwith %}
                          </div>
                        </td>
                      {% endif %}
                    </tr>
                  {% endfor %}
                {% endwith %}
              </tbody>
            </table>
          </div>
        </article>
      </li>
    {% endfor %}
  </ul>
{% endblock lista %}
