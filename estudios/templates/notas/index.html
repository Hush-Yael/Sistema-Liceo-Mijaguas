{% extends "base.html" %}
{% block titulo %}
  Notas
{% endblock titulo %}
{% load static %}
{% load grupos_variantes %}

{% block cabeza %}
  {# componentes #}
  <link rel="stylesheet" href="{% static 'css/componentes/alerta.css' %}" />
  <link
    rel="stylesheet"
    href="{% static 'css/componentes/decoracion-circular.css' %}"
  />
  <link rel="stylesheet" href="{% static 'css/componentes/tabla.css' %}" />
  <link
    rel="stylesheet"
    href="{% static 'css/componentes/htmx-indicator.css' %}"
  />

  {# estilos propios #}
  <link rel="stylesheet" href="{% static 'css/notas/index.css' %}" />
  <style>
    @media only screen and (hover: hover) and (pointer: fine) {
      #filtros {
        scrollbar-color: var(--color-primario-500) transparent;
      }

      .oscuro #filtros {
        scrollbar-color: #888 var(--color-fondo-700);
      }
    }
  </style>

  <script src="{% static 'js/htmx.min.js' %}"></script>
  <script defer src="{% static 'js/htmx-ext-head.js' %}"></script>
  <script defer src="{% static 'js/alpine.min.js' %}"></script>
  <script defer src="{% static 'js/notas/filtros.js' %}"></script>
  <script src="{% static 'js/componentes/tabla-con-fila-sticky.js' %}"></script>

  <script>
    const media = window.matchMedia("(min-width: 800px)");
    media.addEventListener("change", (e) => {
      Alpine.$data($("main")).media_match = e.matches;
    });
  </script>
{% endblock cabeza %}

{% block contenido %}
  <main
    x-data="{ filtros_abiertos: false, media_match: media.matches }"
    @keydown.escape="filtros_abiertos = false"
    @mousedown="!$refs.filtros.contains($event.target) && (filtros_abiertos = false)"
  >
    <div
      x-ref="filtros"
      :aria-hidden="!filtros_abiertos && !media_match"
      :inert="!filtros_abiertos && !media_match"
      class="{{ 'max-[800px]:(fixed z-5 h-[calc(100%-var(--altura-header))] shadow-[4px_0_20px_#0001])  top-[--altura-header] left-0 min-w-200px  border-r border-[--borde-caja] elevado  overflow-y-hidden transition-[transform,opacity] ease-in-out duration-300 bg-[--primario] aria-hidden:(-translate-x-100% opacity-0) aria-[hidden=false]:(translate-x-0 opacity-100) min-[800px]:(translate-x-0 opacity-100 h-full)'|expandir_variantes }}"
    >
      <form
        id="filtros"
        class="incluido-filtros h-full"
        hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
        hx-trigger="change delay:800ms"
        hx-post="{% url 'notas_tabla' %}"
        hx-indicator="#indicador-busqueda"
        hx-target="#tabla-y-paginacion"
        hx-include=".incluido-filtros"
        aria-label="Filtros"
      >
        <div class="space-y-5 h-full p-4 overflow-y-auto">
          {% with post="/guardado_filtro_cookie/" %}
            {% include "notas/lista-filtros.html" with cualquiera_label="Todas" label="Secciones" campo=form.notas_secciones %}
            {#  #}
            {% include "notas/lista-filtros.html" with cualquiera_label="Todas" label="Materias" campo=form.notas_materias %}
            {#  #}
            {% include "notas/lista-filtros.html" with label="Lapso" campo=form.notas_lapsos %}
          {% endwith %}
        </div>
      </form>
    </div>

    <div class="contenido" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
      <div
        class="{{ 'flex flex-wrap gap-2 [&_[role=status],&_[role=alert]]:(justify-between gap-3 p-2 px-3 w-max)'|expandir_variantes }}"
      >
        {% if cantidad_años == 0 %}
          {% include "notas/mensaje-error.html" with mensaje="No se han añadido años académicos" %}
        {% endif %}

        {% if cantidad_lapsos == 0 %}
          {% include "notas/mensaje-error.html" with mensaje="No se han añadido lapsos académicos" %}
        {% endif %}
        <!-- prettier-ignore-start -->
        {% include "notas/estado.html" with label="Totales" dato=total icono='total' %}

        {% include "notas/estado.html" with label="En el conjunto" dato='<span id="conjunto-cantidad" aria-label="cargando">...</span>' icono='conjunto' %}

        {% include "notas/estado.html" with label="Resultados" dato='<span id="resultados-cantidad" aria-label="cargando">...</span>' icono="resultados" %}
        <!-- prettier-ignore-end -->

        <div
          role="status"
          class="htmx-indicator caja flex gap-y-1 aic text-[.875rem] min-[600px]:flex-col min-[1000px]:text-[1.125rem]"
          id="indicador-busqueda"
        >
          <div
            class="indicador size-5! min-[600px]:size-8! min-[600px]:border-5"
          ></div>
          Buscando...
        </div>
      </div>

      {% if total < 1 %}
        <div role="alert" id="msg-vacio" class="mensaje-tabla caja">
          <span class="decoracion-circular">
            {% include "notas/iconos.html#sin_notas" %}
          </span>

          <h2>No se han añadido notas</h2>
        </div>
      {% else %}
        <div class="tabla-contenido">
          {% include "notas/cabecera-tabla.html" %}

          <div
            id="tabla-y-paginacion"
            hx-trigger="load"
            hx-post="{% url 'notas_tabla' %}"
            hx-include=".incluido-filtros"
            class="ma"
          >
            <div role="status" class="mensaje-tabla htmx-indicator">
              <div
                class="indicador"
                style="min-width: 3em; min-height: 3em; border-width: 5px;"
              ></div>
              <h2>Cargando datos...</h2>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </main>
{% endblock contenido %}
