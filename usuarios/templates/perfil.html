{% extends "base.html" %}

{% block titulo %}Perfil{% endblock titulo %}
{% load static %}
{% load widget_tweaks %}

{% block cabeza %}
  <link rel="stylesheet" href="{% static 'css/perfil.css' %}" />
  <link
    rel="stylesheet"
    href="{% static 'css/componentes/htmx-indicator.css' %}"
  />
  <script defer src="{% static 'js/htmx.min.js' %}"></script>
  <script defer src="{% static 'js/perfil.js' %}"></script>
  <script defer src="{% static 'js/btn-subir-autohabilitar.js' %}"></script>
  {% if form.errors %}
    <script defer src="{% static 'js/limpiar-errores.js' %}"></script>
  {% endif %}
{% endblock cabeza %}

{% block contenido %}
  <form method="post" enctype="multipart/form-data">
    <header>
      <hgroup>
        <h1 id="titulo">Perfil de usuario</h1>
        <p class="flex texto-sutil" id="fecha-registro">
          <span class="icono-redondo">
            <svg
              style="transform: scale(.9)"
              viewBox="0 0 448 512"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M0 464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V192H0v272zm320-196c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM192 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM64 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zM400 64h-48V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H160V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H48C21.5 64 0 85.5 0 112v48h448v-48c0-26.5-21.5-48-48-48z"
              />
            </svg>
          </span>
          Registrado el {{ request.user.date_joined }}
        </p>
      </hgroup>

      <div class="enlaces">
        <a class="link-secundario" href="{% url 'cambiar_contraseña' %}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M12 2a5 5 0 0 1 5 5v3a3 3 0 0 1 3 3v6a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3v-6a3 3 0 0 1 3 -3v-3a5 5 0 0 1 5 -5m0 12a2 2 0 0 0 -1.995 1.85l-.005 .15a2 2 0 1 0 2 -2m0 -10a3 3 0 0 0 -3 3v3h6v-3a3 3 0 0 0 -3 -3"
            />
          </svg>
          Cambiar contraseña
        </a>
        <a class="link-primario" id="cerrar-sesion" href="{% url 'logout' %}">
          <svg
            fill="none"
            height="24"
            viewBox="0 0 24 24"
            width="24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M15 3H7C5.89543 3 5 3.89543 5 5V19C5 20.1046 5.89543 21 7 21H15"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
            />
            <path
              d="M19 12L15 8M19 12L15 16M19 12H9"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
            />
          </svg>
          Cerrar sesión
        </a>
      </div>
    </header>

    <hr />

    <div class="datos-contenedor">
      {% csrf_token %}
      {% include "componentes/perfil/datos.html" %}

      <div class="img">
        <div class="flex" id="foto-contenedor">
          <div id="imagen-contenedor">
            {% if form.foto_perfil.errors %}
              {% with error_id=form.foto_perfil.id_for_label|add:'-error' %}
                {% render_field form.foto_perfil class="sr-only" aria-labelledby=error_id aria-invalid="true" %}
              {% endwith %}

              {% for e in form.foto_perfil.errors %}
                {% with error=e %}
                  <p class="input-error">{{ error }}</p>
                {% endwith %}
              {% endfor %}
            {% else %}
              {% render_field form.foto_perfil class="sr-only" %}
            {% endif %}

            <div class="imagen">
              {% if request.user.foto_perfil %}
                <img
                  id="foto"
                  src="{{ request.user.foto_perfil.url }}"
                  alt="foto del perfil"
                />
              {% else %}
                {% include "componentes/iconos/sin-foto.html" with id="foto" %}
              {% endif %}
              <button
                type="button"
                id="ver-foto"
                aria-label="Ver foto de perfil"
              ></button>
            </div>
          </div>

          <div id="foto-botones">
            <label
              for="{{ form.foto_perfil.id_for_label }}"
              id="subir-foto"
              class="btn-primario foto-btn"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                <path d="M7 9l5 -5l5 5" />
                <path d="M12 4l0 12" />
              </svg>

              Subir foto <span class="sr-only">de perfil</span>
            </label>

            {% if request.user.foto_perfil %}
              <button
                class="btn-borde foto-btn"
                id="borrar-foto"
                hx-delete="{% url 'perfil' %}"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-confirm="¿Seguro que quieres borrar tu foto de perfil?"
                hx-swap="outerHTML"
              >
                <span class="htmx-indicator">
                  <span class="indicador"></span>
                </span>
                <svg
                  version="1.1"
                  viewBox="0 0 30 30"
                  xml:space="preserve"
                  height="17"
                  width="17"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                >
                  <path
                    d="M19.71,26h-9.42c-1.019,0-1.875-0.766-1.988-1.779L6.5,8h17l-1.802,16.221C21.585,25.234,20.729,26,19.71,26z"
                  />
                  <path
                    d="M24,6H6C5.448,6,5,5.552,5,5v0c0-0.552,0.448-1,1-1h18c0.552,0,1,0.448,1,1v0C25,5.552,24.552,6,24,6z"
                  />
                  <path
                    d="M18,5h-6V4c0-0.552,0.448-1,1-1h4c0.552,0,1,0.448,1,1V5z"
                  />
                </svg>

                Eliminar foto <span class="sr-only">de perfil</span>
              </button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <hr />

    <div class="datos-contenedor" id="campos-contenedor">
      <div id="datos" role="group">
        <h2>Datos del usuario</h2>

        <div>
          {% for field in form %}
            {% if field.id_for_label != 'id_foto_perfil' %}
              <div class="campo">
                {{ field.label_tag }}
                {% if field.errors %}
                  {% with error=field.id_for_label|add:'-error' %}
                    {% render_field field class="elevado" aria-labelledby=error aria-invalid="true" %}
                  {% endwith %}
                {% else %}
                  {% render_field field class="elevado" %}
                {% endif %}

                {% if field.errors %}
                  {% for error in field.errors %}
                    <p id="{{ field.id_for_label }}-error" class="input-error">
                      {{ error }}
                    </p>
                  {% endfor %}
                {% endif %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      </div>

      <button disabled id="submit" class="btn-primario btn-md">
        Guardar cambios
      </button>
    </div>
  </form>

  <dialog id="img-dialog">
    <div>
      <img
        {% if request.user.foto_perfil %}
          src="{{ request.user.foto_perfil.url }}"
        {% endif %}
        alt="foto"
      />
    </div>
  </dialog>
{% endblock contenido %}
