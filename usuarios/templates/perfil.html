{% extends "base.html" %}

{% block titulo %}Perfil{% endblock titulo %}
{% load static %}
{% load widget_tweaks %}
{% load grupos_variantes %}

{% block cabeza %}
  <link rel="stylesheet" href="{% static 'css/perfil.css' %}" />
  <link
    rel="stylesheet"
    href="{% static 'css/componentes/htmx-indicator.css' %}"
  />
  <link rel="stylesheet" href="{% static 'css/componentes/dialog.css' %}" />

  <script defer src="{% static 'js/htmx.min.js' %}"></script>
  <script defer src="{% static 'js/perfil.js' %}"></script>
  <script defer src="{% static 'js/btn-subir-autohabilitar.js' %}"></script>
  {% if form.errors %}
    <script defer src="{% static 'js/limpiar-errores.js' %}"></script>
  {% endif %}
{% endblock cabeza %}

{% block contenido %}
  <main
    class="{{ "col gap-y-4 w-full max-w-900px m-[0_auto] p-4 [&_hr]:w-full [&_hr]:border-[--borde-caja] min-[525px]:p-5 min-[600px]:p-8 "|expandir_variantes }}"
  >
    <header
      class="col justify-between gap-2 col-span-3 min-[700px]:flex-row min-[700px]:aic"
    >
      <hgroup>
        <h1 class="font-bold text-[1.25rem]">Perfil de usuario</h1>
        <p class="flex texto-sutil" id="fecha-registro">
          <span class="icono-redondo">
            <svg
              style="transform: scale(.9)"
              viewBox="0 0 448 512"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M0 464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V192H0v272zm320-196c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM192 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12h-40c-6.6 0-12-5.4-12-12v-40zM64 268c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zm0 128c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12H76c-6.6 0-12-5.4-12-12v-40zM400 64h-48V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H160V16c0-8.8-7.2-16-16-16h-32c-8.8 0-16 7.2-16 16v48H48C21.5 64 0 85.5 0 112v48h448v-48c0-26.5-21.5-48-48-48z"
              />
            </svg>
          </span>
          Registrado el {{ request.user.date_joined|date:"D. d M. Y, h:i A" }}
        </p>
      </hgroup>

      <div
        class="flex gap-y-3 gap-x-1 aic flex-wrap min-[700px]:flex-col min-[700px]:items-start"
      >
        <a class="link-secundario" href="{% url 'cambiar_contraseña' %}">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="18"
            height="18"
            viewBox="0 0 24 24"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none" />
            <path
              d="M12 2a5 5 0 0 1 5 5v3a3 3 0 0 1 3 3v6a3 3 0 0 1 -3 3h-10a3 3 0 0 1 -3 -3v-6a3 3 0 0 1 3 -3v-3a5 5 0 0 1 5 -5m0 12a2 2 0 0 0 -1.995 1.85l-.005 .15a2 2 0 1 0 2 -2m0 -10a3 3 0 0 0 -3 3v3h6v-3a3 3 0 0 0 -3 -3"
            />
          </svg>
          Cambiar contraseña
        </a>
        <a class="link-primario" id="cerrar-sesion" href="{% url 'logout' %}">
          <svg
            class="size-[.875rem] -scale-x-100 translate-y-1px"
            fill="none"
            height="24"
            viewBox="0 0 24 24"
            width="24"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M15 3H7C5.89543 3 5 3.89543 5 5V19C5 20.1046 5.89543 21 7 21H15"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
            />
            <path
              d="M19 12L15 8M19 12L15 16M19 12H9"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
            />
          </svg>
          Cerrar sesión
        </a>
      </div>
    </header>

    <hr />

    <form
      method="post"
      enctype="multipart/form-data"
      class="{{ "col gap-y-4 [&>div]:col [&>div]:gap-y-4 min-[700px]:(grid grid-cols-[1fr_auto_1fr] gap-x-6)"|expandir_variantes }}"
    >
      <div>
        {% csrf_token %}
        {% include "componentes/perfil/datos.html" %}

        <div
          class="{{ "col gap-y-4 min-[500px]:max-[700px]:(justify-center aic gap-x-8 flex-row) max-[700px]:mb-4 min-[900px]:gap-y-8 min-[900px]:flex-row"|expandir_variantes }}"
        >
          <div class="col aic gap-y-4 tac">
            {% if form.foto_perfil.errors %}
              {% for e in form.foto_perfil.errors %}
                {% with error=e %}
                  <p class="input-error">{{ error }}</p>
                {% endwith %}
              {% endfor %}
            {% endif %}

            <div
              class="{{ "relative max-w-max [&>img,&>svg]:(size-[11rem] min-w-max border-7 border-#fffa dark:border-#fff3 rounded-full object-cover italic tac lh-[11rem] shadow-[0_0_10px_#0001,_0_7px_15px_#0001] dark:shadow-none)"|expandir_variantes }}"
            >
              {% if request.user.foto_perfil %}
                <img
                  id="foto"
                  src="{{ request.user.foto_perfil.url }}"
                  alt="foto del perfil"
                />
              {% else %}
                {% include "componentes/iconos/sin-foto.html" with id="foto" %}
              {% endif %}
              <button
                type="button"
                id="ver-foto"
                class="absolute top-0 left-0 right-0 bottom-0 border-3 border-#0000 rounded-full outline-none transition-[border-color] ease media-mouse:focus-visible:border-primario dark:media-mouse:focus-visible:border-primario-700 media-touch:focus-visible:border-primario-500"
                aria-label="Ver foto de perfil"
              ></button>
            </div>
          </div>

          <div class="flex flex-wrap justify-center aic gap-2">
            {% if form.foto_perfil.errors %}
              {% with error_id=form.foto_perfil.id_for_label|add:'-error' %}
                {% render_field form.foto_perfil class="sr-only peer" aria-labelledby=error_id aria-invalid="true" %}
              {% endwith %}
            {% else %}
              {% render_field form.foto_perfil class="sr-only peer" %}
            {% endif %}

            <label
              for="{{ form.foto_perfil.id_for_label }}"
              class="{{ "btn-primario p-[.375rem_.75rem] [&>svg]:size-[1.125em] cursor-pointer max-[500px]:text-[.9em] media-mouse:peer-focus:(outline-2 outline-#000 outline-offset-1) dark:media-mouse:peer-focus:outline-#fff"|expandir_variantes }}"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <path stroke="none" d="M0 0h24v24H0z" fill="none" />
                <path d="M4 17v2a2 2 0 0 0 2 2h12a2 2 0 0 0 2 -2v-2" />
                <path d="M7 9l5 -5l5 5" />
                <path d="M12 4l0 12" />
              </svg>

              Subir foto <span class="sr-only">de perfil</span>
            </label>

            {% if request.user.foto_perfil %}
              <button
                class="btn-borde p-[.375rem_.75rem] [&>svg]:size-[1.125em] max-[500px]:text-[.9em]"
                id="borrar-foto"
                hx-delete="{% url 'perfil' %}"
                hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                hx-confirm="¿Seguro que quieres borrar tu foto de perfil?"
                hx-swap="outerHTML"
              >
                <span class="htmx-indicator">
                  <span class="indicador"></span>
                </span>
                <svg
                  version="1.1"
                  viewBox="0 0 30 30"
                  xml:space="preserve"
                  height="17"
                  width="17"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                >
                  <path
                    d="M19.71,26h-9.42c-1.019,0-1.875-0.766-1.988-1.779L6.5,8h17l-1.802,16.221C21.585,25.234,20.729,26,19.71,26z"
                  />
                  <path
                    d="M24,6H6C5.448,6,5,5.552,5,5v0c0-0.552,0.448-1,1-1h18c0.552,0,1,0.448,1,1v0C25,5.552,24.552,6,24,6z"
                  />
                  <path
                    d="M18,5h-6V4c0-0.552,0.448-1,1-1h4c0.552,0,1,0.448,1,1V5z"
                  />
                </svg>

                Eliminar foto <span class="sr-only">de perfil</span>
              </button>
            {% endif %}
          </div>
        </div>
      </div>

      <hr
        class="{{ "min-[700px]:(h-full min-w-1px bg-[--borde-caja])"|expandir_variantes }}"
      />

      <div>
        <div
          class="{{ "col flex gap-y-3 gap-x-1 min-[525px]:max-[700px]:[&>div]:(flex-wrap grid grid-cols-2 gap-x-4) max-[700px]:mb-4 "|expandir_variantes }}"
          role="group"
        >
          <h2 class="font-bold text-[1.25rem]">Datos del usuario</h2>

          <div class="col gap-y-5 p-2 [&_label]:text-texto-sutil">
            {% for field in form %}
              {% if field.id_for_label != 'id_foto_perfil' %}
                <div class="campo">
                  {{ field.label_tag }}
                  {% if field.errors %}
                    {% with error=field.id_for_label|add:'-error' %}
                      {% render_field field class="elevado" aria-labelledby=error aria-invalid="true" %}
                    {% endwith %}
                  {% else %}
                    {% render_field field class="elevado" %}
                  {% endif %}

                  {% if field.errors %}
                    {% for error in field.errors %}
                      <p
                        id="{{ field.id_for_label }}-error"
                        class="input-error"
                      >
                        {{ error }}
                      </p>
                    {% endfor %}
                  {% endif %}
                </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>

        <button
          disabled
          class="btn-primario btn-md mt-auto min-[700px]:ml-auto"
        >
          Guardar cambios
        </button>
      </div>
    </form>
  </main>

  <dialog id="img-dialog">
    <div>
      <img
        class="aspect-square object-cover"
        {% if request.user.foto_perfil %}
          src="{{ request.user.foto_perfil.url }}"
        {% endif %}
        alt="foto"
      />
    </div>
  </dialog>
{% endblock contenido %}
