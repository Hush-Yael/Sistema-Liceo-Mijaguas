{% load grupos_variantes %}
{% load utilidades %}
{% load partials %}

{% with label_id="{{ campo.name }}-lista-{{ cual_lista }}" %}
  <div
    role="group"
    class="{{ lista_contenedor_class|default:''|add:" flex-1 border border-[--borde-caja]" }}"
  >
    <div class="flex aic gap-x-2 p-1 px-2">
      <p
        {{ label_id|default:None }}
        class="mra text-sm font-bold text-texto-semi-sutil"
      >
        <span x-show="{{ cuales_selecciones_visuales }}.size > 0">
          <span x-text="{{ cuales_selecciones_visuales }}.size"></span>
          de
        </span>
        {% if opciones_agrupadas %}
          <span
            x-text="_flatOpciones{% if cuales_opciones != 'opcionesDisponibles' %}Seleccionadas{% else %}Disponibles{% endif %}.length"
          ></span>
        {% else %}
          <span x-text="{{ cuales_opciones }}.length"></span>
        {% endif %}
        <span>
          <span class="sr-only">Opciones</span>
          {% if cual_lista == 'disponibles' %}
            {{ label_cantidad_disponibles|default:'disponibles' }}
          {% else %}
            {{ label_cantidad_seleccionadas|default:'seleccionadas' }}
          {% endif %}
        </span>
      </p>

      {% with c="ui-btn aspect-square p-1 size-7 pover:bg-[--transparente-1]" %}
        <button
          type="button"
          type="button"
          @click="limpiarVisualmenteTodo('{{ cual_lista }}')"
          x-cloak
          x-show="{{ cuales_selecciones_visuales }}.size > 0"
          class="{{ c }}"
          aria-label="Limpiar selecciÃ³n"
        >
          <svg
            fill="none"
            stroke-width="2"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path d="M12 8h3a1 1 0 0 1 1 1v3"></path>
            <path d="M16 16h-7a1 1 0 0 1 -1 -1v-7"></path>
            <path d="M12 20v.01"></path>
            <path d="M16 20v.01"></path>
            <path d="M8 20v.01"></path>
            <path d="M4 20v.01"></path>
            <path d="M4 16v.01"></path>
            <path d="M4 12v.01"></path>
            <path d="M4 8v.01"></path>
            <path d="M8 4v.01"></path>
            <path d="M12 4v.01"></path>
            <path d="M16 4v.01"></path>
            <path d="M20 4v.01"></path>
            <path d="M20 8v.01"></path>
            <path d="M20 12v.01"></path>
            <path d="M20 16v.01"></path>
            <path d="M3 3l18 18"></path>
          </svg>
        </button>

        <button
          type="button"
          class="{{ c }}"
          @click="seleccionarVisualmenteTodo('{{ cual_lista }}')"
          {% if opciones_agrupadas %}
            x-show="_flatOpciones{% if cuales_opciones != 'opcionesDisponibles' %}Seleccionadas{% else %}Disponibles{% endif %}.length
            > 0 && {{ cuales_selecciones_visuales }}.size <
            _flatOpciones{% if cuales_opciones != 'opcionesDisponibles' %}Seleccionadas{% else %}Disponibles{% endif %}.length"
          {% else %}
            x-show="{{ cuales_opciones }}.length > 0 &&
            {{ cuales_selecciones_visuales }}.size <
            {{ cuales_opciones }}.length"
          {% endif %}
          x-cloak
          aria-label="Seleccionar todas las opciones"
        >
          <svg
            fill="none"
            stroke-width="2"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
            <path
              d="M8 8m0 1a1 1 0 0 1 1 -1h6a1 1 0 0 1 1 1v6a1 1 0 0 1 -1 1h-6a1 1 0 0 1 -1 -1z"
            ></path>
            <path d="M12 20v.01"></path>
            <path d="M16 20v.01"></path>
            <path d="M8 20v.01"></path>
            <path d="M4 20v.01"></path>
            <path d="M4 16v.01"></path>
            <path d="M4 12v.01"></path>
            <path d="M4 8v.01"></path>
            <path d="M4 4v.01"></path>
            <path d="M8 4v.01"></path>
            <path d="M12 4v.01"></path>
            <path d="M16 4v.01"></path>
            <path d="M20 4v.01"></path>
            <path d="M20 8v.01"></path>
            <path d="M20 12v.01"></path>
            <path d="M20 16v.01"></path>
            <path d="M20 20v.01"></path>
          </svg>
        </button>
      {% endwith %}
    </div>

    {% if busqueda_activa %}
      <label
        class="{{ "group flex aic gap-x-2 border-b border-t border-[--borde-caja] p-2 focus-within:(ring-current ring-1)"|expandir_variantes }}"
      >
        <span class="sr-only">Buscar</span>

        <span
          class="fc bg-[--transparente-1] rounded-full p-1 aspect-square text-texto-sutil"
        >
          {% include "componentes/iconos/tabla.html#lupa" with class="size-3.5" %}
        </span>

        <input
          type="text"
          {% if opciones_agrupadas %}
            :disabled="!_flatOpciones{% if cuales_opciones != 'opcionesDisponibles' %}Seleccionadas{% else %}Disponibles{% endif %}.length"
          {% else %}
            :disabled="!{{ cuales_opciones }}.length"
          {% endif %}
          class="w-full outline-none text-sm focus-visible:border-primario "
          id="busqueda-{{ cual_lista }}"
          @input="
            clearTimeout(this.timeoutBusqueda);
            this.timeoutBusqueda = setTimeout(() => {
              {% if cual_lista == 'disponibles' %}busquedaDisponibles{% else %}busquedaSeleccionadas{% endif %} = $el.value
            }, 500)"
          autocomplete="off"
          placeholder="Buscar"
        />
      </label>
    {% endif %}

    <ul
      class="{{ lista_class|default:""|add:" lista-opciones group py-2 overflow-y-auto" }}"
      aria-labelledby="{{ label_id }}"
      role="listbox"
      aria-multiselectable="true"
      x-data="{ enfocadoPorTeclado: false }"
      x-trap="enfocadoPorTeclado"
      @keydown='manejoTeclas($event, "{{ cual_lista }}")'
      @click.outside="enfocadoPorTeclado = false"
      @click.prevent="
          if ($event.target.getAttribute('role') === 'option')
            alternarSeleccionVisual('{{ cual_lista }}', $event.target.getAttribute('data-id'))
        "
      {% comment %}<!-- prettier-ignore-start -->{% endcomment %}
        @dblclick="
          if ($event.target.getAttribute('role') === 'option')
            {% if cual_lista == 'disponibles' %}
              moverASeleccionadas($event.target.getAttribute('data-id'))
            {% else %}
                moverADisponibles($event.target.getAttribute('data-id'))
            {% endif %}
        "
        {% comment %}<!-- prettier-ignore-end -->{% endcomment %}
      {% if cuales_opciones == 'opcionesDisponibles' %}
        data-lista="disponibles"
      {% else %}
        data-lista="seleccionadas"
      {% endif %}
    >
      <template
        {% if busqueda_activa %}
          x-for=" ({% if opciones_agrupadas %}grupo{% else %}opcion{% endif %},
          indice) in filtrarOpciones('{{ cual_lista }}',
          '{{ cual_lista }}-sinResultadosMsj') "
        {% else %}
          x-for="({% if opciones_agrupadas %}grupo{% else %}opcion{% endif %},
          indice) in {{ cuales_opciones }}"
        {% endif %}
        {% if opciones_agrupadas %}
          :key="'{{ campo.name }}-{{ cual_lista }}-' + grupo.label"
        {% else %}
          :key="'{{ campo.name }}-{{ cual_lista }}-' + opcion.id"
        {% endif %}
      >
        {% if opciones_agrupadas %}
          <li>
            <p
              class="pl-4 py-1 font-bold first-letter:capitalize data-[opciones='0']:hidden"
              x-text="grupo.label"
              :data-opciones="grupo.opciones.length"
            ></p>
            <ul>
              <template
                x-for="(opcion, indice) in grupo.opciones"
                :key="'{{ campo.name }}-{{ cual_lista }}-opcion-' + opcion.id"
              >
                {% with opcion_class="pl-6 text-texto-semi-sutil" %}
                  {% partial opcion %}
                {% endwith %}
              </template>
            </ul>
          </li>
        {% else %}
          {% partial opcion %}
        {% endif %}
      </template>

      {% with c="fc flex-col gap-y-3 h-full p-4 text-center text-texto-sutil font-500" ic="fc size-9 p-0.5 aspect-square bg-[--transparente-1] rounded" %}
        {% if busqueda_activa %}
          <li class="{{ c }}" x-ref="{{ cual_lista }}-sinResultadosMsj">
            <span class="{{ ic|add:' p-1.5' }}">
              {% include "componentes/iconos/opciones.html#sin_resultados" %}
            </span>
            No se encontraron resultados
          </li>
        {% endif %}

        <li
          {% if opciones_agrupadas %}
            x-show="_flatOpciones{% if cuales_opciones != 'opcionesDisponibles' %}Seleccionadas{% else %}Disponibles{% endif %}.length
            === 0"
          {% else %}
            x-show="{{ cuales_opciones }}.length === 0"
          {% endif %}
          class="{{ c }}"
        >
          <span class="{{ ic }}">
            {% include "componentes/iconos/opciones.html#sin_opciones" %}
          </span>

          {% if cuales_opciones != 'opcionesDisponibles' %}
            {{ msg_sin_opciones_seleccionadas|default:"No se seleccionaron opciones" }}
          {% else %}
            {{ msg_sin_opciones_disponibles|default:"No hay opciones para escoger" }}
          {% endif %}
        </li>
      {% endwith %}
    </ul>
  </div>
{% endwith %}

{% partialdef opcion %}
  <li
    role="option"
    class="{{
      opcion_class|default:''|add:'
        relative flex aic gap-x-3 p-2 px-3 transition-colors select-none cursor-pointer
        group-[[data-lista=disponibles]]:aria-selected:ui-btn/primario
        group-[[data-lista=seleccionadas]]:aria-selected:ui-btn/secundario
        not-[[aria-selected=true]]:(pover:bg-[--transparente-1] focus-visible:bg-[--transparente-1])
      '
      |reemplazar_espacios:' '
      |expandir_variantes
    }}"
    :tabindex="indice === 0 ? 0 : -1"
    :data-indice="indice"
    :data-id="opcion.id"
    :aria-selected="visualmenteSeleccionada('{{ cual_lista }}', opcion.id) ? 'true' : 'false'"
    :aria-labelledby="'{{ campo.name }}-disponible-label-' + opcion.id"
    :id="'{{ campo.name }}-{{ cual_lista }}-label-' + opcion.id"
    x-text="opcion.label"
  ></li>
{% endpartialdef opcion %}
